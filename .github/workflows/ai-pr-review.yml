name: AI PR Review

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate OpenAI key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "Missing required GitHub secret: OPENAI_API_KEY"
            exit 1
          fi

      - name: Generate and post AI review comment
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const marker = '<!-- ai-pr-review -->';
            const maxChars = 120000;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100
            });

            const filePatches = files.map(file => {
              const patch = file.patch || '[No patch available: binary file, rename only, or patch too large]';
              return `File: ${file.filename}\nStatus: ${file.status}\nPatch:\n${patch}`;
            }).join('\n\n');

            const trimmedPatch = filePatches.length > maxChars
              ? `${filePatches.slice(0, maxChars)}\n\n[Truncated due to size limits.]`
              : filePatches;

            const reviewPrompt = [
              'You are a senior software engineer performing a pull request review.',
              'Focus on correctness, regressions, security, and missing tests.',
              'Keep output concise and structured as:',
              '1) Critical findings',
              '2) Medium findings',
              '3) Minor findings',
              '4) Merge recommendation (Ready / Needs changes).',
              'If there are no issues in a section, write "None".'
            ].join('\n');

            const prSummary = [
              `PR Title: ${pr.data.title}`,
              `PR Number: #${pull_number}`,
              `Base: ${pr.data.base.ref}`,
              `Head: ${pr.data.head.ref}`,
              `Description:\n${pr.data.body || '[No description provided]'}`,
              '',
              `Changed files (${files.length}):`,
              trimmedPatch
            ].join('\n');

            const aiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                temperature: 0.2,
                messages: [
                  { role: 'system', content: reviewPrompt },
                  { role: 'user', content: prSummary }
                ]
              })
            });

            if (!aiResponse.ok) {
              const failureBody = await aiResponse.text();
              core.setFailed(`OpenAI API call failed (${aiResponse.status}): ${failureBody}`);
              return;
            }

            const aiPayload = await aiResponse.json();
            const reviewText = aiPayload?.choices?.[0]?.message?.content?.trim() || 'AI review returned no content.';

            const commentBody = [
              marker,
              '## AI PR Review',
              '',
              '_Model: `gpt-4o-mini`_',
              '',
              reviewText
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100
            });

            const existingComment = comments.find(comment =>
              comment.user?.login === 'github-actions[bot]' &&
              typeof comment.body === 'string' &&
              comment.body.includes(marker)
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: commentBody
              });
            }
